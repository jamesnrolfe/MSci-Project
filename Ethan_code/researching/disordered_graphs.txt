using Graphs
using Plots
using GraphRecipes # Needs to be explicitly installed and used for graphplot
using Random
using LinearAlgebra

# Note: You may need to install these packages first:
# import Pkg
# Pkg.add("Graphs")
# Pkg.add("Plots")
# Pkg.add("GraphRecipes")

Random.seed!(42) # Use a fixed seed for reproducible visualization

"""
Creates a weighted adjacency matrix for a completely connected graph.
(Copied from your script)
"""
function create_weighted_adj_mat(N::Int, σ::Float64; μ::Float64=1.0)
    if σ == 0.0
        A = ones(Float64, N, N)
        A -= Matrix{Float64}(I, N, N)
        return A
    end
    A = zeros(Float64, N, N)
    for i in 1:N, j in (i+1):N
        weight = μ + σ * randn()
        A[i, j] = A[j, i] = weight
    end
    return A
end

"""
Main function to generate and save the graph visualization.
"""
function visualize_clustering()
    println("--- Starting Part 4: Disordered Graph Visualization ---")

    # --- Parameters ---
    N = 10       # Small system to visualize
    μ = 1.0      # Mean coupling
    σ = 0.75     # High disorder to make clustering obvious

    # --- Generate Graph Data ---
    adj_mat = create_weighted_adj_mat(N, σ; μ=μ)
    
    # Create a Graph object from the adjacency matrix
    # We only want to draw edges that exist (non-zero)
    # For a fully connected graph, all are non-zero (except for i=j)
    g = Graphs.Graph(adj_mat) # This creates a graph based on non-zero entries

    # --- Prepare data for plotting ---
    
    # We need to extract edge weights in the order GraphRecipes expects
    edge_weights = []
    edge_colors = []
    
    # Define a colormap
    # We'll use a diverging colormap: blue (weak) -> white (mean) -> red (strong)
    cmap = cgrad(:bwr, [μ - 2σ, μ, μ + 2σ], categorical=false)

    # Loop over the edges in the graph object
    for edge in edges(g)
        i, j = src(edge), dst(edge)
        weight = adj_mat[i, j]
        push!(edge_weights, abs(weight) / μ) # Scale width by normalized weight
        push!(edge_colors, weight)
    end

    # --- Generate Plot ---
    println("Generating plot for N=$N, σ=$σ...")

    # Set backend
    # gr() # Use the default GR backend for Plots

    # Create the plot
    p = graphplot(
        g,
        layout = spring_layout, # Use a force-directed layout
        names = 1:N,
        fontsize = 10,
        nodeshape = :circle,
        nodecolor = :lightblue,
        
        # Edge properties
        edge_width = edge_weights .* 2, # Multiply for visibility
        edge_color = edge_colors,
        seriescolor = cmap,
        
        # Plot attributes
        title = "Disordered Couplings (N=$N, σ=$σ, μ=$μ)\nRed=Strong, Blue=Weak",
        colorbar_title = "Coupling Strength (J_ij)",
        size = (800, 800),
        dpi = 150
    )

    # --- Save Plot ---
    filename = "disordered_graph_N$(N)_sigma$(σ).png"
    savefig(p, filename)
    
    println("Visualization complete.")
    println("Plot saved to: $filename")
    println("Observe the plot for 'clusters' of thick, red (strong) couplings")
    println("and areas with thin, blue (weak) couplings.")

end

# Run the visualization
visualize_clustering()